# 微信公众号发布工作流参考

## 完整发布流程

```
┌─────────────────────────────────────────────────────────┐
│                    第一步：AI 文档转换                    │
├─────────────────────────────────────────────────────────┤
│  Claude AI 收到任务后，会：                               │
│  1. 读取文章内容（Markdown/Word/PDF）                        │
│  2. 按照 SKILL.md 中的规范转换为 HTML                      │
│  3. 应用微信公众号样式规范（标题、段落、列表等）             │
│  4. 生成符合微信阅读体验的完整 HTML                       │
│                                                             │
│  输出：带有内联样式的 HTML 字符串                          │
└─────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────┐
│                第二步：微信草稿管理（本 Skill）             │
├─────────────────────────────────────────────────────────┤
│  1. 接收 AI 生成的 HTML                                   │
│  2. 生成封面图片（模板生成或使用 AI 生成的图片）         │
│  3. 上传封面到微信素材库                                     │
│  4. 调用微信公众号 API 创建草稿                           │
│  5. 返回草稿 media_id 用于后续更新                          │
│                                                             │
│  核心功能：                                                   │
│  - 上传素材到微信素材库（通过 API）                         │
│  - 创建新草稿                                                 │
│  - 更新已有草稿                                               │
│  - API 调用重试和错误处理                                     │
└─────────────────────────────────────────────────────────┘
```

## 为什么这样设计？

| 优势 | 说明 |
|------|------|
| **职责分离** | AI 擅长内容理解和样式应用，脚本专注 API 操作 |
| **质量更高** | AI 能理解语义，生成更符合公众号风格的内容 |
| **维护简单** | 不需要维护复杂的文档解析逻辑，脚本只做 API 调用 |
| **灵活扩展** | 可以轻松更换 AI 提供商或转换方式 |
| **持续改进** | AI 能力持续提升，无需重新部署脚本 |

## 标准发布工作流

### 1. 准备阶段

**配置检查：**
```bash
# 检查 .env 文件是否存在
cat .env

# 确认以下配置项：
# - WECHAT_APP_ID
# - WECHAT_APP_SECRET
```

**文章准备：**
- [ ] 文章内容已完成
- [ ] Markdown 格式正确
- [ ] 图片素材已准备
- [ ] 封面图已确定

### 2. 内容转换

**AI 转换：**
```
请将以下文章转换为微信公众号格式的 HTML，
应用 SKILL.md 中的样式规范。
```

**手动转换（可选）：**
```bash
# 仅生成 HTML，不上传
python3 scripts/cli.py publish article.md --no-api

# 生成的文件：output/article.html
```

### 3. 预览检查

**检查清单：**
- [ ] 标题样式正确（渐变背景）
- [ ] 章节标题有左侧边框
- [ ] 段落间距适当
- [ ] 代码块支持横向滚动
- [ ] 表格样式正确
- [ ] 图片尺寸合适

### 4. 上传发布

**API 模式：**
```bash
# 直接上传到草稿箱
python3 scripts/cli.py publish article.md
```

**手动模式：**
```bash
# 生成 HTML 后手动复制
python3 scripts/cli.py publish article.md --no-api
# 然后在微信公众号后台手动粘贴
```

### 5. 验证

**在微信公众号后台检查：**
- [ ] 文章显示正常
- [ ] 图片加载正常
- [ ] 链接可点击
- [ ] 代码格式正确
- [ ] 移动端显示正常

## 草稿更新工作流

### 场景：修改已发布的草稿

```bash
# 更新草稿内容
python3 scripts/cli.py update <media_id>

# 指定新的源文件
python3 scripts/cli.py update <media_id> --source new-article.md

# 重新生成封面
python3 scripts/cli.py update <media_id> --regenerate-cover
```

### 更新流程

1. **获取 media_id** - 从之前的发布记录或后台获取
2. **准备新内容** - 更新 Markdown 文件或 HTML
3. **执行更新** - 运行更新命令
4. **验证结果** - 在后台检查更新后的内容

## 图片管理工作流

### 上传单张图片

```bash
python3 scripts/cli.py upload-image image.jpg
```

**输出：**
```
✅ 图片上传成功!
   Media ID: s_UokPQPIM8nkGd3QjvYHKBlYRM6jVf5NnD2lMCNya1ig...
   URL: https://mmbiz.qpic.cn/...
   类型: image
```

### 批量上传图片

```bash
python3 scripts/cli.py upload-images ./images
```

**输出：**
```
📁 找到 3 个图片文件

[1/3] 上传: image1.jpg... ✅
[2/3] 上传: image2.jpg... ✅
[3/3] 上传: image3.jpg... ✅

============================================================
✅ 上传完成!
   成功: 3
   失败: 0
============================================================

📋 成功上传的图片:
文件名                         Media ID
------------------------------------------------------------
image1.jpg              s_UokPQPIM8nkGd3QjvYHKBlYRM6...
image2.jpg              s_UokPQPIM8nkGd3QjvYHFa0QOodg...
image3.jpg              s_UokPQPIM8nkGd3QjvYHH2tsvGFRb...
```

## 常见工作流场景

### 场景 1: 技术教程发布

1. **编写 Markdown** - 包含代码块、语法说明
2. **AI 转换** - 应用代码高亮样式
3. **检查代码块** - 确认横向滚动正常
4. **上传发布** - 使用 API 直接发布

### 场景 2: 图文混排文章

1. **准备图片** - 压缩、调整尺寸
2. **批量上传** - 上传所有图片到素材库
3. **AI 转换** - 生成带图片引用的 HTML
4. **替换链接** - 将本地链接替换为 CDN URL
5. **上传发布** - 创建草稿

### 场景 3: 系列专栏

1. **创建模板** - 统一的封面风格、样式
2. **批量处理** - 使用脚本批量转换
3. **统一发布** - 保持时间间隔
4. **归档管理** - 记录 media_id

## 错误处理工作流

### API 调用失败

**错误类型：**
- access_token 过期
- 网络超时
- API 限流
- 参数错误

**处理流程：**
1. **查看日志** - `output/mp-weixin.log`
2. **检查配置** - 确认 .env 配置正确
3. **重试机制** - 脚本已内置重试
4. **手动模式** - 降级到手动上传

### 图片上传失败

**可能原因：**
- 文件过大
- 格式不支持
- 网络问题

**解决方法：**
1. **压缩图片** - 使用 TinyPNG 等工具
2. **检查格式** - 确认是 JPG 或 PNG
3. **分批上传** - 避免同时上传过多
4. **检查配额** - 确认素材库未满

## 最佳实践

### 发布时间选择

**最佳发布时间：**
- 工作日：8:00-9:00，12:00-13:00，18:00-21:00
- 周末：9:00-11:00，15:00-17:00，20:00-22:00

### 内容预览

**预览检查点：**
1. **移动端预览** - 使用手机预览功能
2. **不同机型** - iOS 和 Android 都测试
3. **网络环境** - WiFi 和 4G/5G 都测试

### 发布后跟踪

**跟踪指标：**
- 阅读量
- 点赞量
- 在看量
- 分享量
- 收藏量
- 留言数

### 数据分析

**分析维度：**
- 标题效果对比
- 发布时间影响
- 内容类型表现
- 封面图吸引力

## 自动化脚本示例

### 一键发布脚本

```bash
#!/bin/bash
# publish.sh - 一键发布脚本

ARTICLE=$1

if [ -z "$ARTICLE" ]; then
    echo "Usage: ./publish.sh article.md"
    exit 1
fi

echo "🚀 开始发布文章: $ARTICLE"

# 转换并发布
python3 scripts/cli.py publish "$ARTICLE"

if [ $? -eq 0 ]; then
    echo "✅ 发布成功!"
else
    echo "❌ 发布失败，请检查日志"
    exit 1
fi
```

### 批量发布脚本

```bash
#!/bin/bash
# batch-publish.sh - 批量发布脚本

ARTICLES_DIR="./articles"

for article in "$ARTICLES_DIR"/*.md; do
    echo "📝 处理文章: $article"
    python3 scripts/cli.py publish "$article"
    echo "⏳ 等待 10 秒..."
    sleep 10
done

echo "✅ 批量发布完成!"
```
